services:
  mongodb:
    image: mongo:latest
    container_name: sapienza-zen-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  redis:
    image: redis:latest
    container_name: sapienza-zen-redis
    ports:
      - "6379:6379"

  httpapi-host:
    build:
      context: .
      dockerfile: Sapienza.Sapienza.Dominus.HttpApi.Host/Dockerfile
    container_name: sapienza-zen-api
    depends_on:
      - mongodb
      - redis
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - "App:SelfUrl=http://localhost:44322"
      - "App:CorsOrigins=http://localhost:44360,http://localhost:4200"
      - "Redis:Configuration=redis:6379"
      - "ConnectionStrings:Default=mongodb://mongodb:27017/Sapienza.Dominus"
      - "AuthServer:Authority=http://localhost:44322"
      - "AuthServer:RequireHttpsMetadata=false"
    ports:
      - "44322:8080"

  web:
    build:
      context: .
      dockerfile: Sapienza.Sapienza.Dominus.Web/Dockerfile
    container_name: sapienza-zen-web
    depends_on:
      - httpapi-host
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - "App:SelfUrl=http://localhost:44360"
      - "Redis:Configuration=redis:6379"
      - "ConnectionStrings:Default=mongodb://mongodb:27017/Sapienza.Dominus"
      - "AuthServer:Authority=http://host.docker.internal:44322"
      - "AuthServer:RequireHttpsMetadata=false"
    ports:
      - "44360:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  mongodb_data:
